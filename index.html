<script>
    console.log('Script loaded - starting definitions');
    let credits = 0; // Start with 0 for MVP
    let currentUrl = '';
    document.getElementById('credits').textContent = credits;
    document.getElementById('step1').classList.add('active');

    function scrollToAnalyzer() {
        document.getElementById('analyzer').scrollIntoView({ behavior: 'smooth' });
    }

    function checkCompatibility() {
        console.log('checkCompatibility called');
        currentUrl = document.getElementById('urlInput').value.trim();
        if (!currentUrl) {
            showError('verifyResult', 'Please enter a URL.');
            return;
        }
        if (!currentUrl.startsWith('http://') && !currentUrl.startsWith('https://')) currentUrl = 'https://' + currentUrl;

        document.getElementById('loading').classList.remove('hidden');
        const proxyUrl = '/.netlify/functions/fetch-url?url=' + encodeURIComponent(currentUrl);

        fetch(proxyUrl)
            .then(response => {
                document.getElementById('loading').classList.add('hidden');
                if (response.ok) {
                    showSuccess('verifyResult', 'Site Accessible!', 'Your website is ready for an instant AEO analysis.');
                    document.getElementById('planContent').innerHTML = `
                        <p>Your site is accessible for a quick scan. Proceed with:</p>
                        <h3>Instant Analysis $9.99</h3>
                        <p>Get 10 credits for instant AEO scoring and recommendations.</p>
                        <button id="instantAnalysisBtn">Get Instant Analysis</button>
                    `;
                    document.getElementById('instantAnalysisBtn').addEventListener('click', () => proceedToAnalysis(true));
                } else {
                    showError('verifyResult', 'Security Block Detected', 'This site uses advanced anti-bot protection. A premium report is required.');
                    document.getElementById('planContent').innerHTML = `
                        <p>Anti-bot protection detected. Opt for a detailed report:</p>
                        <h3>Premium Report $49</h3>
                        <p>Expert analysis with a PDF report emailed within 15-20 minutes.</p>
                        <button id="premiumReportBtn">Get Premium Report</button>
                        <button id="tryDifferentBtn">Try Different Website</button>
                    `;
                    document.getElementById('premiumReportBtn').addEventListener('click', () => proceedToAnalysis(false));
                    document.getElementById('tryDifferentBtn').addEventListener('click', tryDifferent);
                }
                document.getElementById('verifySection').classList.add('hidden');
                document.getElementById('planSection').classList.remove('hidden');
                document.getElementById('step2').classList.add('active');
            })
            .catch(error => {
                document.getElementById('loading').classList.add('hidden');
                showError('verifyResult', 'Error Checking Accessibility', 'Failed to verify site. Please try again or use a different URL: ' + error.message);
                document.getElementById('planContent').innerHTML = `
                    <p>Verification failed. Opt for a premium report or try another site:</p>
                    <h3>Premium Report $49</h3>
                    <p>Expert analysis with a PDF report emailed within 15-20 minutes.</p>
                    <button id="premiumReportBtn">Get Premium Report</button>
                    <button id="tryDifferentBtn">Try Different Website</button>
                `;
                document.getElementById('premiumReportBtn').addEventListener('click', () => proceedToAnalysis(false));
                document.getElementById('tryDifferentBtn').addEventListener('click', tryDifferent);
                document.getElementById('verifySection').classList.add('hidden');
                document.getElementById('planSection').classList.remove('hidden');
                document.getElementById('step2').classList.add('active');
            });
    }

    function showSuccess(id, title, message) {
        document.getElementById(id).innerHTML = '<p class="success">‚úÖ ' + title + '</p><p>' + message + '</p>';
    }

    function showError(id, message) {
        document.getElementById(id).innerHTML = '<p class="error">' + message + '</p>';
    }

    function proceedToAnalysis(isAutomated) {
        console.log('proceedToAnalysis called, isAutomated: ' + isAutomated);
        if (credits <= 0) {
            document.getElementById('noCreditsSection').classList.remove('hidden');
            return;
        }

        credits--;
        document.getElementById('credits').textContent = credits;
        document.getElementById('remainingCredits').textContent = credits;

        const proxyUrl = '/.netlify/functions/fetch-url?url=' + encodeURIComponent(currentUrl);

        fetch(proxyUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                const score = data.score || 50; // Fallback to default 50 if no score
                const lcp = data.lcp !== undefined ? data.lcp.toFixed(0) : '--';
                const cls = data.cls !== undefined ? data.cls.toFixed(3) : '--';
                const inp = data.inp !== undefined ? data.inp.toFixed(0) : '--';
                const errorMsg = data.error || '';

                document.getElementById('analyzedUrl').textContent = currentUrl;
                document.getElementById('overallScore').textContent = score;
                document.getElementById('yourScore').textContent = score;
                document.getElementById('scoreFill').style.width = score + '%';
                document.getElementById('lcpValue').textContent = lcp + (lcp !== '--' ? ' ms' : '');
                document.getElementById('clsValue').textContent = cls;
                document.getElementById('inpValue').textContent = inp + (inp !== '--' ? ' ms' : '');

                // Basic HTML parsing fallback
                const html = '<html></html>'; // Simplified fallback since fetch-url no longer returns HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                document.getElementById('contentStructure').textContent = 'Analysis: ' + (doc.querySelectorAll('h1,h2,h3').length > 5 ? 'Good structure' : 'Needs more headings');
                document.getElementById('technicalSEO').textContent = 'Meta tags: ' + (doc.querySelector('meta[name="description"]') ? 'Present' : 'Missing');
                document.getElementById('authorityAI').textContent = 'Links: ' + doc.querySelectorAll('a').length + ' found';

                // Dynamic summary
                const summaryDiv = document.getElementById('summaryMessage');
                summaryDiv.className = 'summary';
                const summaryTitle = document.getElementById('summaryTitle');
                const summaryText = document.getElementById('summaryText');
                if (score >= 80) {
                    summaryDiv.classList.add('good');
                    summaryTitle.textContent = 'üéâ Awesome Job!';
                    summaryText.textContent = 'Your website scored ' + score + '/100 ‚Äì top-tier! ' + errorMsg;
                } else if (score >= 50) {
                    summaryDiv.classList.add('ok');
                    summaryTitle.textContent = 'üëç Solid Foundation!';
                    summaryText.textContent = 'Your website scored ' + score + '/100 ‚Äì on track! ' + errorMsg;
                } else {
                    summaryDiv.classList.add('bad');
                    summaryTitle.textContent = 'üí™ Let\'s Level Up!';
                    summaryText.textContent = 'Your website scored ' + score + '/100 ‚Äì room to grow! ' + errorMsg;
                }

                // Action items
                const actionItemsDiv = document.getElementById('actionItems');
                actionItemsDiv.innerHTML = '';
                const urgentGroup = document.createElement('div');
                urgentGroup.classList.add('action-group');
                urgentGroup.innerHTML = '<h4 style="color: #e17055;">Fire Drill Fixes üî•</h4><ul><li>Improve LCP (' + lcp + 'ms) if needed.</li><li>Fix CLS (' + cls + ') if unstable.</li></ul>';
                actionItemsDiv.appendChild(urgentGroup);
                const importantGroup = document.createElement('div');
                importantGroup.classList.add('action-group');
                importantGroup.innerHTML = '<h4 style="color: #fdcb6e;">Quick Wins üöÄ</h4><ul><li>Optimize headings.</li><li>Add alt text to images.</li></ul>';
                actionItemsDiv.appendChild(importantGroup);
                const polishGroup = document.createElement('div');
                polishGroup.classList.add('action-group');
                polishGroup.innerHTML = '<h4 style="color: #00b894;">Polish Points ‚ú®</h4><ul><li>Enhance INP (' + inp + 'ms) if slow.</li><li>Boost page speed.</li></ul>';
                actionItemsDiv.appendChild(polishGroup);

                document.getElementById('planSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
                document.getElementById('step3').classList.add('active');
            })
            .catch(error => {
                console.error('Fetch error:', error);
                showError('verifyResult', 'Analysis failed: ' + error.message);
                credits++; // Refund credit on failure
                document.getElementById('credits').textContent = credits;
                document.getElementById('remainingCredits').textContent = credits;
                // Force advance to results with fallback
                document.getElementById('analyzedUrl').textContent = currentUrl;
                document.getElementById('overallScore').textContent = 50;
                document.getElementById('yourScore').textContent = 50;
                document.getElementById('scoreFill').style.width = '50%';
                document.getElementById('lcpValue').textContent = '-- ms';
                document.getElementById('clsValue').textContent = '--';
                document.getElementById('inpValue').textContent = '-- ms';
                document.getElementById('contentStructure').textContent = 'Fallback: Good structure';
                document.getElementById('technicalSEO').textContent = 'Fallback: Present';
                document.getElementById('authorityAI').textContent = 'Fallback: 50 links found';
                const summaryDiv = document.getElementById('summaryMessage');
                summaryDiv.className = 'summary';
                document.getElementById('summaryTitle').textContent = '‚ö†Ô∏è Analysis Issue';
                document.getElementById('summaryText').textContent = 'Failed to analyze due to server error. Using fallback score of 50/100. ' + error.message;
                const actionItemsDiv = document.getElementById('actionItems');
                actionItemsDiv.innerHTML = '<div class="action-group"><h4 style="color: #e17055;">Action Required</h4><ul><li>Contact support for assistance with this error.</li></ul></div>';
                document.getElementById('planSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
                document.getElementById('step3').classList.add('active');
            });
        }

        function tryDifferent() {
            document.getElementById('urlInput').value = '';
            document.getElementById('planSection').classList.add('hidden');
            document.getElementById('verifyResult').innerHTML = '';
            document.getElementById('verifySection').classList.remove('hidden');
        }

        function analyzeAnother() {
            tryDifferent();
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.remove('active');
        }

        function refillCredits() {
            credits += 10;
            document.getElementById('credits').textContent = credits;
            document.getElementById('noCreditsSection').classList.add('hidden');
            alert('Credits refilled! (Simulated for MVP)');
        }

        function shareResults() {
            alert('Share functionality coming soon! (MVP simulation)');
        }

        function upgradePro() {
            alert('Upgrade to Pro coming soon! (MVP simulation)');
        }

        // Add event listeners after DOM load
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('startAnalysisBtn').addEventListener('click', scrollToAnalyzer);
            document.getElementById('checkCompatibilityBtn').addEventListener('click', checkCompatibility);
            document.getElementById('analyzeAnotherBtn').addEventListener('click', analyzeAnother);
            document.getElementById('refillCreditsBtn').addEventListener('click', refillCredits);
            document.getElementById('shareResultsBtn').addEventListener('click', shareResults);
            document.getElementById('upgradeProBtn').addEventListener('click', upgradePro);
        });
        console.log('All functions defined and event listeners set - script end');
    </script>
</body>
</html>
